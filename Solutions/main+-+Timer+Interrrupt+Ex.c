////////////////////////////////////////////////////////////////////////////////////// ECE 2534:        Interrupt Example for 2534// File name:       main - Timer Interrupt Ex.c// Description:     Two timer w/ interrupts that illustrate priorities// Resources:       timer2 is configured to interrupt every 1.0ms, and//                  timer4 is configured to interrupt every 10ms.//                  The timer4 ISR has an (approximately) 4.5ms delay.//                  As long as timer2 has a higher priority, the times//                  computed by both timers agree (when the constant//                  CORRECT_ISR_PRIORITIES is defined). When this line//                  is commented out, the priorities are inverted and//                  then timer2 (now lower priority) must wait for a//                  delay loop in the timer4 ISR to finish before being//                  executed. A logic analyzer can be used to see//                  exactly what is happening in the ISRs and the OLED//                  update (header JB, pins 1, 2, and 3).// Written by:      PEP// Last modified:   10/10/2015// Commenting out the following line will reverse the ISR priorities.#define CORRECT_ISR_PRIORITIES#define _PLIB_DISABLE_LEGACY#include <plib.h>#include "PmodOLED.h"#include "OledChar.h"#include "OledGrph.h"#include "delay.h"#include "stdbool.h"// intrumentation for the logic analyzer (or oscilliscope)#define MASK_DBG1  0x1;#define MASK_DBG2  0x2;#define MASK_DBG3  0x4;#define DBG_ON(a)  LATESET = a#define DBG_OFF(a) LATECLR = a#define DBG_INIT() TRISECLR = 0x7// timer4 delay, approximately 4.5ms based on a prescalar of 16#define TIMER4_ISR_DELAY 2812// Implementation-dependent features#ifndef OVERRIDE_CONFIG_BITS#pragma config FPLLMUL  = MUL_20        // PLL Multiplier#pragma config FPLLIDIV = DIV_2         // PLL Input Divider#pragma config FPLLODIV = DIV_1         // PLL Output Divider#pragma config FPBDIV   = DIV_8         // Peripheral Clock divisor#pragma config FWDTEN   = OFF           // Watchdog Timer#pragma config WDTPS    = PS1           // Watchdog Timer Postscale#pragma config FCKSM    = CSDCMD        // Clock Switching & Fail Safe Clock Monitor#pragma config OSCIOFNC = OFF           // CLKO Enable#pragma config POSCMOD  = HS            // Primary Oscillator#pragma config IESO     = OFF           // Internal/External Switch-over#pragma config FSOSCEN  = OFF           // Secondary Oscillator Enable#pragma config FNOSC    = PRIPLL        // Oscillator Selection#pragma config CP       = OFF           // Code Protect#pragma config BWP      = OFF           // Boot Flash Write Protect#pragma config PWP      = OFF           // Program Flash Write Protect#pragma config ICESEL   = ICS_PGx1      // ICE/ICD Comm Channel Select#pragma config DEBUG    = OFF           // Debugger Disabled for Starter Kit#endif // OVERRIDE_CONFIG_BITS// Global variables to count number of times in timer ISRsunsigned int timer2_value = 0;unsigned int timer4_value = 0;// The interrupt handler for timer2// IPL7 highest interrupt priority// SOFT|AUTO|SRS refers to the shadow register use#ifdef CORRECT_ISR_PRIORITIESvoid __ISR(_TIMER_2_VECTOR, IPL7SRS)  _Timer2Handler(void) {#elsevoid __ISR(_TIMER_2_VECTOR, IPL4AUTO) _Timer2Handler(void) {#endif    DBG_ON(MASK_DBG1);    timer2_value++; // Update millisecond counter    INTClearFlag(INT_T2); // Acknowledge TMR2 interrupt    DBG_OFF(MASK_DBG1);    return;}// The interrupt handler for the timer4// IPL4 is a medium level priority#ifdef CORRECT_ISR_PRIORITIESvoid __ISR(_TIMER_4_VECTOR, IPL4AUTO) _Timer4Handler(void) {#elsevoid __ISR(_TIMER_4_VECTOR, IPL7SRS)  _Timer4Handler(void) {#endif    DBG_ON(MASK_DBG2);    int i;    timer4_value++;    // delay loop so that we spend extra time in this ISR    while (ReadTimer4() < TIMER4_ISR_DELAY) {    }    INTClearFlag(INT_T4);    DBG_OFF(MASK_DBG2);    return;}int main() {    char oledstring[17];    unsigned int timer2_value_save, timer4_value_save;    unsigned int last_oled_update = 0;    unsigned int ms_since_last_oled_update;    // Initialize GPIO for LEDs    TRISGCLR = 0xf000; // For LEDs: configure PortG pins for output    ODCGCLR = 0xf000; // For LEDs: configure as normal output (not open drain)    LATGCLR = 0xf000; // Initialize LEDs to 0000    // Initialize GPIO for debugging    DBG_INIT();    // Initialize Timer1 and OLED for display    DelayInit();    OledInit();    // Initialize timer2    // Set up the period for timer2 to be 1 millisec    OpenTimer2(T2_ON | T2_SOURCE_INT | T2_PS_1_16, 624);    // Initialize timer4    // Set up the period for timer4 to be 10 millisec    OpenTimer4(T4_ON | T4_SOURCE_INT | T4_PS_1_16, 6249);    // Set up the CPU to respond to interrupts from Timer2#ifdef CORRECT_ISR_PRIORITIES    INTSetVectorPriority(INT_TIMER_2_VECTOR, INT_PRIORITY_LEVEL_7);#else    INTSetVectorPriority(INT_TIMER_2_VECTOR, INT_PRIORITY_LEVEL_4);#endif    INTClearFlag(INT_T2);    INTEnable(INT_T2, INT_ENABLED);    // Set up the CPU to respond to interrupts from Timer4#ifdef CORRECT_ISR_PRIORITIES    INTSetVectorPriority(INT_TIMER_4_VECTOR, INT_PRIORITY_LEVEL_4);#else    INTSetVectorPriority(INT_TIMER_4_VECTOR, INT_PRIORITY_LEVEL_7);#endif    INTClearFlag(INT_T4);    INTEnable(INT_T4, INT_ENABLED);    // Configure the system for vectored interrupts    INTConfigureSystem(INT_SYSTEM_CONFIG_MULT_VECTOR);    // Enable the interrupt controller    INTEnableInterrupts();    // Send a welcome message to the OLED display    OledClearBuffer();    OledSetCursor(0, 0);    OledPutString("Interrupt Ex");    OledSetCursor(0, 1);    OledPutString("2534-Fall 2015");    OledUpdate();    // Main processing loop    while (1) {        ms_since_last_oled_update = timer2_value - last_oled_update;        if (ms_since_last_oled_update >= 100) {            DBG_ON(MASK_DBG3);            LATGSET = 1 << 12; // Turn LED1 on            timer2_value_save = timer2_value;            timer4_value_save = timer4_value;            last_oled_update = timer2_value;            sprintf(oledstring, "T2 Val: %6d", timer2_value_save / 100);            OledSetCursor(0, 2);            OledPutString(oledstring);            sprintf(oledstring, "T4 Val: %6d", timer4_value_save / 10);            OledSetCursor(0, 3);            OledPutString(oledstring);            OledUpdate();            LATGCLR = 1 << 12; // Turn LED1 off            DBG_OFF(MASK_DBG3);        }    }    return 0;}